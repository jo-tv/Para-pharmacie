<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Catalogue Produits</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- CDN Bootstrap + DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <!-- Buttons Extension for Export -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css"
    />
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <style>
      /* Ø¹Ø§Ù… */
      html,
      body {
        height: 100%;
      }
      body {
        background: #f8f9fa;
        min-height: 100vh;
        display: flex;
        overflow-x: hidden; /* Ù…Ù†Ø¹ overflow Ø£ÙÙ‚ÙŠ */
        margin: 0;
      }

      /* SIDEBAR */
      #sidebar {
        min-width: 220px;
        max-width: 220px;
        background: #343a40;
        color: #fff;
        transition:
          left 0.3s ease,
          transform 0.3s ease;
        height: 100vh;
        position: fixed;
        top: 0;
        left: -220px; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        z-index: 1000;
        overflow-y: auto;
      }
      #sidebar.active {
        left: 0;
      }
 #sidebar .nav-link {
        color: #fff;
        padding: 10px;
        font-size: 13px;
        font-weight: 900;
        border-radius: 0.5rem;
        margin-bottom: 15px;
        text-transform: uppercase;
        transition: 0.25s;
      }
      #sidebar .nav-link i {
        margin-right: 10px;
        font-size: 25px;
      }
      #sidebar .nav-link:hover {
        background: #495057;
        color: #0dcaf0;
        transform: translateX(5px);
      }
      #sidebar .nav-link.active {
        background: #0dcaf0;
        color: #fff;
      }

      /* CONTENT */
      #content {
        flex: 1;
        padding: 20px;
        margin-left: 0; /* ÙŠØªØºÙŠØ± Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ sidebar */
        transition: margin-left 0.3s ease;
        width: 100%;
      }
      /* Ø¹Ù†Ø¯Ù…Ø§ Ù†Ø¶ÙŠÙ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ø§Ø³ ÙŠØªÙ… Ø¯Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ÙŠÙ…ÙŠÙ† */
      .withSidebar {
        margin-left: 220px !important;
      }

      /* Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ */
      #sidebarToggle {
        display: inline-block;
      }

      /* Ù†Ù…Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ­Ù‚ÙˆÙ„ Ø§Ù„ÙÙˆØ±Ù… */
      .form-control:focus {
        box-shadow: none;
        border-color: #0dcaf0;
      }
      .btn-submit {
        background: #0dcaf0;
        color: #fff;
        border: none;
      }
      .btn-submit:hover {
        background: #0bb8d9;
      }

      /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù */
      .btn-edit,
      .btn-delete {
        font-size: 0.9rem;
        padding: 0.35rem 0.6rem;
      }

      /* Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ø´Ø§Ø´Ø© ÙƒØ¨ÙŠØ±Ø©ØŒ Ù†ÙØ¨Ù‚ÙŠ sidebar Ù…ÙØªÙˆØ­Ù‹Ø§ Ø¯Ø§Ø¦Ù…Ù‹Ø§ */
      @media (min-width: 768px) {
        #sidebar {
          left: 0;
        }
        #sidebar.active {
          left: 0;
        }
        #sidebarToggle {
          display: none;
        } /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
      }
      .forJoute {
        display: none;
      }
      .activeAjoute {
        display: block;
      }
      .table {
        width: 100%;
        text-align: center;
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <nav
      id="sidebar"
      class="d-flex flex-column p-3"
    >
      <a
        href="#"
        class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none"
      >
        <i class="bi bi-heart-pulse-fill fs-4 me-2"></i>
        <span class="fs-4">Parapharmacie</span>
      </a>
      <hr />
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a
            href="/"
            class="nav-link"
            ><i class="bi bi-speedometer2"></i> Dashboard</a
          >
        </li>
        <li>
          <a
            href="/ajouter"
            class="nav-link"
            ><i class="bi bi-box-seam"></i> Ajouter Produit</a
          >
        </li>
        <li>
          <a
            href="/product"
            class="nav-link active"
            ><i class="bi bi-cart-check"></i> produit</a
          >
        </li>
        <li>
          <a
            href="#"
            class="nav-link"
            ><i class="bi bi-people"></i> Clients</a
          >
        </li>
        <li>
          <a
            href="#"
            class="nav-link"
            ><i class="bi bi-gear"></i> ParamÃ¨tres</a
          >
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div id="content">
      <nav class="navbar navbar-light bg-light mb-4">
        <div class="container-fluid">
          <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ -->
          <button
            class="btn btn-outline-secondary d-md-none"
            id="sidebarToggle"
          >
            â˜° Menu
          </button>
          <span class="navbar-brand mb-0 h1">ğŸ’Š Catalogue Produits</span>
        </div>
      </nav>

      <div class="container mt-4">
        <table
          id="productsTable"
          class="table table-striped table-bordered table-hover"
        >
          <thead class="table-dark">
            <tr>
              <th>Nom</th>
              <th>Prix (DH)</th>
              <th>QuantitÃ©</th>
              <th>Date Expiration</th>
              <th>Code-barre</th>
            </tr>
          </thead>
          <tbody id="productsBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      // Sidebar
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      const content = document.getElementById('content');

      // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          sidebar.classList.toggle('active');
          content.classList.toggle('withSidebar');
        });
      }

      // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø©
      function handleResize() {
        if (window.innerWidth >= 768) {
          sidebar.classList.add('active');
          content.classList.add('withSidebar');
          if (toggleBtn) toggleBtn.style.display = 'none';
        } else {
          sidebar.classList.remove('active');
          content.classList.remove('withSidebar');
          if (toggleBtn) toggleBtn.style.display = 'inline-block';
        }
      }

      window.addEventListener('load', handleResize);
      window.addEventListener('resize', handleResize);

      // ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      let products = [];

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      async function loadProducts() {
        try {
          const res = await fetch('/api/products');
          products = await res.json();
          renderProducts(products);
        } catch (err) {
          console.error('Erreur lors du chargement des produits:', err);
        }
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      function renderProducts(list) {
        const tbody = document.getElementById('productsBody');
        tbody.innerHTML = '';

        list.forEach((p) => {
          const expiryDate = p.expiry ? new Date(p.expiry).toLocaleDateString() : 'â€”';

          tbody.innerHTML += `
      <tr>
        <td>${p.name}</td>
        <td>${p.price} DH</td>
        <td>${p.quantity}</td>
        <td>${expiryDate}</td>
        <td>${p.barcode}</td>
      </tr>
    `;
        });

        // ØªÙ‡ÙŠØ¦Ø© DataTable Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if ($.fn.DataTable.isDataTable('#productsTable')) {
          $('#productsTable').DataTable().destroy();
        }

        $('#productsTable').DataTable({
          responsive: true,
          pageLength: 10,
          lengthMenu: [10, 20, 50, 100],
          dom: 'Bfrtip',
          buttons: [
            { extend: 'excelHtml5', text: 'ğŸ“¥ Excel', className: 'btn btn-success' },
            { extend: 'csvHtml5', text: 'ğŸ“¥ CSV', className: 'btn btn-info' },
            { extend: 'pdfHtml5', text: 'ğŸ“¥ PDF', className: 'btn btn-danger' },
            { extend: 'print', text: 'ğŸ–¨ï¸ Print', className: 'btn btn-secondary' },
          ],
          language: {
            url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json',
          },
        });
      }

      function filterProducts() {
        const query = searchQuery.value.toLowerCase().trim();
        const expiryVal = searchExpiry.value; // YYYY-MM-DD Ù…Ù† input[type=date]

        const filtered = products.filter((p) => {
          // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯
          const matchesQuery =
            !query ||
            p.name.toLowerCase().includes(query) ||
            p.barcode.toLowerCase().includes(query);

          // ÙÙ„ØªØ±Ø© Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
          const matchesExpiry = expiryVal
            ? new Date(p.expiry).toISOString().slice(0, 10) === expiryVal
            : true;

          return matchesQuery && matchesExpiry;
        });

        renderProducts(filtered);
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„ Ù…Ø±Ø©
      loadProducts();
    </script>
  </body>
</html>
