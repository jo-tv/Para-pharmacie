<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Catalogue Produits</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="css/facture.css"
      type="text/css"
      media="all"
    />
  </head>
  <body>
    <!-- Sidebar -->
    <nav
      id="sidebar"
      class="d-flex flex-column p-3"
    >
      <a
        href="#"
        class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none"
      >
        <i class="bi bi-heart-pulse-fill fs-4 me-2"></i>
        <span class="fs-4">Parapharmacie</span>
      </a>
      <hr />
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a
            href="/"
            class="nav-link"
            ><i class="bi bi-speedometer2"></i> Dashboard</a
          >
        </li>
        <li>
          <a
            href="/ajouter"
            class="nav-link"
            ><i class="bi bi-boxes"></i> Ajouter Produit</a
          >
        </li>
        <li>
          <a
            href="/product"
            class="nav-link"
            ><i class="bi bi-boxes"></i> produit</a
          >
        </li>
        <li>
          <a
            href="/caisse"
            class="nav-link"
            ><i class="bi bi-cart-plus"></i> Caisse</a
          >
        </li>
        <li>
          <a
            href="/ticket"
            class="nav-link active"
            ><i class="bi bi-bag-check-fill"></i> Ticket</a
          >
        </li>
        <li>
          <a
            href="#"
            class="nav-link"
            ><i class="bi bi-people"></i> Clients</a
          >
        </li>
        <li>
          <a
            href="#"
            class="nav-link"
            ><i class="bi bi-gear"></i> Param√®tres</a
          >
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div id="content">
      <nav class="navbar navbar-light bg-light mb-4">
        <div class="container-fluid">
          <!-- ÿ≤ÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑŸÑŸáŸàÿßÿ™ŸÅ -->
          <button
            class="btn btn-outline-secondary d-md-none"
            id="sidebarToggle"
          >
            ‚ò∞ Menu
          </button>
          <span class="navbar-brand mb-0 h1">üíä Catalogue Produits</span>
        </div>
      </nav>
      <div class="mb-3 text-center">
        <button
          id="printBtn"
          class="btn btn-dark"
        >
          üñ®Ô∏è Imprimer
        </button>
        <button
          id="pdfBtn"
          class="btn btn-danger"
        >
          üìÑ T√©l√©charger PDF
        </button>
      </div>

      <div class="invoice">
        <div class="row">
          <div class="col-7">
            <img
              src="https://i.postimg.cc/k41NXPLX/Photoroom-20250915-231503.png"
              class="logo"
            />
          </div>
          <div class="col-5">
            <h1 class="document-type display-4">FACTURE</h1>
            <h5 class="barcode"></h5>
          </div>
        </div>
        <div class="row">
          <div class="col-7">
            <p class="addressMySam">
              <strong class="fs-3">Para √† Petit Prix</strong><br />
              N61 TALLOUJTE 02 CITE MOHAMMADIA MARRAKECH
            </p>
          </div>
          <div class="col-5">
            <br /><br /><br />
            <div class="addressDriver">
              Nom Client<br />
              <h5 contenteditable>Le Nom Client</h5>
              ICE :
              <h5 contenteditable>12345678910</h5>
            </div>
          </div>
        </div>
        <br />
        <br />
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Description</th>
              <th>QTE</th>
              <th class="text-right">PRIX</th>
              <th class="text-right">TOTAL</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Frais de service MySam √† 5% pour la p√©riode du</td>
              <td>2</td>
              <td class="text-right">130</td>
              <td class="text-right">260</td>
            </tr>
          </tbody>
        </table>
        <div class="row">
          <div class="col-8"></div>
          <div class="col-4">
            <table class="table table-sm text-right">
              <tr>
                <td><strong>Total HT</strong></td>
                <td
                  class="text-right"
                  th:text="${totalHT}"
                >
                  0,00
                </td>
              </tr>
              <tr>
                <td>TVA 20%</td>
                <td
                  class="text-right"
                  th:text="${totalTVA}"
                >
                  0,00
                </td>
              </tr>
              <tr>
                <td><strong>Total TTC</strong></td>
                <td
                  class="text-right"
                  th:text="${totalTTC}"
                >
                  0,00
                </td>
              </tr>
            </table>
          </div>
        </div>

        <div class="footer">
          <p>N61 TALLOUJTE 02 CITE MOHAMMADIA MARRAKECH T√©l:0679547979</p>
          <p>RC: 126564 Pat: 67000100 IF: 25067018 CNSS: 5865871 ICE: 002047392000037</p>
          <p>Email: parapetitprix61@gmail.com</p>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const data = localStorage.getItem('factureData');
        if (!data) {
          alert('‚ö†Ô∏è Aucune facture trouv√©e !');
          return;
        }

        const sale = JSON.parse(data);

        // üßæ ÿ®ŸÜÿßÿ° ÿßŸÑÿ¨ÿØŸàŸÑ
        const tbody = document.querySelector('table.table-striped tbody');
        tbody.innerHTML = '';
        sale.items.forEach((item) => {
          const row = document.createElement('tr');
          row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.quantity}</td>
        <td class="text-right">${item.price.toFixed(2)}</td>
        <td class="text-right">${(item.quantity * item.price).toFixed(2)}</td>
      `;
          tbody.appendChild(row);
        });

        // ‚úÖ ÿßŸÑŸÖÿ¨ÿßŸÖŸäÿπ
        const totalHT = sale.totalHT.toFixed(2);
        const totalTTC = sale.totalTTC.toFixed(2);
        const totalTVA = (sale.totalTTC - sale.totalHT).toFixed(2);

        document.querySelector('[th\\:text="${totalHT}"]').textContent = totalHT;
        document.querySelector('[th\\:text="${totalTVA}"]').textContent = totalTVA;
        document.querySelector('[th\\:text="${totalTTC}"]').textContent = totalTTC;

        document.querySelector('.barcode').textContent = ' N¬∞ ' + sale.ticketBarcode;

        // üñ®Ô∏è ÿ≤ÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        document.getElementById('printBtn').addEventListener('click', () => {
          window.print();
        });

        // üìÑ ÿ≤ÿ± PDF
        document.getElementById('pdfBtn').addEventListener('click', () => {
          const element = document.querySelector('.invoice');
          html2pdf().from(element).set({
  margin: 0,
  filename: `facture_${sale.ticketBarcode}.pdf`,
  html2canvas: { scale: 2, useCORS: true },
  jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
  pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
}).save();
        });
      });
    </script>
    <script>
      // ----- Sidebar toggle -----
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      const content = document.getElementById('content');

      if (toggleBtn && sidebar && content) {
        toggleBtn.addEventListener('click', () => {
          sidebar.classList.toggle('active');
          content.classList.toggle('withSidebar');
        });
      }

      function handleResize() {
        if (window.innerWidth >= 768) {
          if (sidebar && content) {
            sidebar.classList.add('active');
            content.classList.add('withSidebar');
          }
          if (toggleBtn) toggleBtn.style.display = 'none';
        } else {
          if (sidebar && content) {
            sidebar.classList.remove('active');
            content.classList.remove('withSidebar');
          }
          if (toggleBtn) toggleBtn.style.display = 'inline-block';
        }
      }

      window.addEventListener('load', handleResize);
      window.addEventListener('resize', handleResize);
    </script>
  </body>
</html>
